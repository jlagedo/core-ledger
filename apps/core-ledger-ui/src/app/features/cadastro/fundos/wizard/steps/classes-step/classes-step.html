<div class="classes-step">
  <form [formGroup]="form" class="step-form" novalidate>
    <!-- Section: Multiclasse Toggle (RF-01) -->
    <div class="classes-toggle-section">
      <div class="classes-toggle__header">
        <div class="classes-toggle__icon">
          <i class="bi bi-layers" aria-hidden="true"></i>
        </div>
        <div class="classes-toggle__text">
          <h6 class="classes-toggle__title">Estrutura de Classes (CVM 175)</h6>
          <p class="classes-toggle__subtitle">Este fundo possui estrutura multiclasse?</p>
        </div>
        <!-- Template Button -->
        @if (isMulticlasse() || classesObrigatorias()) {
          <button
            type="button"
            class="btn btn-sm btn-outline-secondary classes-toggle__template-btn"
            (click)="openTemplateModal()"
            aria-label="Selecionar template de classes"
          >
            <i class="bi bi-grid-3x3-gap" aria-hidden="true"></i>
            Templates
          </button>
        }
      </div>

      <div class="classes-toggle__options">
        <label class="classes-toggle__option" [class.classes-toggle__option--selected]="!isMulticlasse()">
          <input
            type="radio"
            name="multiclasse"
            [value]="false"
            formControlName="multiclasse"
            class="visually-hidden"
            [attr.disabled]="classesObrigatorias() ? '' : null"
          />
          <span class="classes-toggle__radio"></span>
          <span class="classes-toggle__label">
            <span class="classes-toggle__label-text">Nao</span>
            <span class="classes-toggle__label-desc">Classe unica</span>
          </span>
        </label>

        <label class="classes-toggle__option" [class.classes-toggle__option--selected]="isMulticlasse()">
          <input
            type="radio"
            name="multiclasse"
            [value]="true"
            formControlName="multiclasse"
            class="visually-hidden"
          />
          <span class="classes-toggle__radio"></span>
          <span class="classes-toggle__label">
            <span class="classes-toggle__label-text">Sim</span>
            <span class="classes-toggle__label-desc">Multiplas classes</span>
          </span>
        </label>
      </div>

      @if (classesObrigatorias()) {
        <div class="classes-toggle__notice">
          <i class="bi bi-info-circle" aria-hidden="true"></i>
          <span>Para FIDCs, a estrutura multiclasse e obrigatoria.</span>
        </div>
      }
    </div>

    <!-- Section: No Multiclasse Message -->
    @if (!isMulticlasse() && !classesObrigatorias()) {
      <div class="classes-single-mode">
        <div class="classes-single-mode__icon">
          <i class="bi bi-check-circle" aria-hidden="true"></i>
        </div>
        <div class="classes-single-mode__content">
          <h6 class="classes-single-mode__title">Classe Unica Configurada</h6>
          <p class="classes-single-mode__text">
            O fundo operara com classe unica. Nenhuma configuracao adicional e necessaria.
            Voce pode avancar para o proximo passo.
          </p>
        </div>
      </div>
    }

    <!-- Section: FIDC Waterfall (when applicable) -->
    @if (showFidcWaterfall()) {
      <app-fidc-waterfall [classesFormGroups]="classesFormGroups()" />
    }

    <!-- Section: Two-Panel Layout -->
    @if (isMulticlasse() || classesObrigatorias()) {
      <div class="classes-panels" formArrayName="classes">
        <!-- Overview Panel (Left) -->
        <div class="classes-panels__overview">
          <app-class-overview-panel
            [classesFormGroups]="classesFormGroups()"
            [selectedIndex]="selectedClassIndex()"
            [isFidc]="isFidc()"
            [maxClasses]="maxClasses"
            [hasOrdemGapError]="hasOrdemGapError()"
            [hasCodigoDuplicadoError]="hasCodigoDuplicadoError()"
            (classSelected)="onClassSelected($event)"
            (addClass)="onAddClass($event)"
            (removeClass)="onRemoveClass($event)"
          />
        </div>

        <!-- Detail Panel (Right) -->
        <div class="classes-panels__detail">
          @if (selectedClassFormGroup(); as selectedGroup) {
            <app-class-detail-panel
              [classeFormGroup]="selectedGroup"
              [classeIndex]="selectedClassIndex()!"
              [isFidc]="isFidc()"
            />
          } @else {
            <!-- Empty state when no class selected -->
            <div class="classes-panels__empty-detail">
              <div class="classes-panels__empty-icon">
                <i class="bi bi-cursor-text" aria-hidden="true"></i>
              </div>
              <p class="classes-panels__empty-text">
                Selecione uma classe na lista para editar seus dados.
              </p>
              @if (classesCount() === 0) {
                <button
                  type="button"
                  class="btn btn-sm btn-outline-secondary"
                  (click)="onAddClass({})"
                >
                  <i class="bi bi-plus-lg" aria-hidden="true"></i>
                  Adicionar Classe
                </button>
              }
            </div>
          }
        </div>
      </div>

      <!-- Validation Errors Summary -->
      @if (hasSeniorObrigatorioError()) {
        <div class="classes-validation-error">
          <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
          <span>FIDC deve ter pelo menos uma classe Senior configurada.</span>
        </div>
      }
    }

    <!-- Form Footer -->
    <div class="step-form__footer">
      <div class="step-hint">
        <i class="bi bi-lightbulb step-hint__icon" aria-hidden="true"></i>
        <span class="step-hint__text">
          @if (isFidc()) {
            Para FIDCs, e obrigatoria a criacao de pelo menos uma classe <strong>Senior</strong>.
            A cascata de subordinacao define a prioridade de recebimento.
          } @else {
            Estrutura multiclasse e opcional. Se habilitada, preencha todos os campos
            obrigatorios (<span class="text-danger">*</span>) para cada classe.
          }
        </span>
      </div>
    </div>
  </form>
</div>
